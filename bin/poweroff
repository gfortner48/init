#!/bin/sh
#
# This script handles poweroff/reboot for a myriad of inits without needing
# each one to provide its own commands for this purpose. This may be delegated
# to each init (as it was before), just seeing how this goes.

case $(id -u) in 0) ;; *)
    printf 'error: must be root\n' >&2
    exit 1
esac

[ -f /etc/rc.conf ] && . /etc/rc.conf

case ${CONFIG_INIT:=busybox} in
    busybox)
        case ${0##*/} in
            reboot)   kill -s TERM 1 ;;
            poweroff) kill -s USR2 1 ;;
        esac
    ;;

    sinit)
        case ${0##*/} in
            reboot)   kill -s INT  1 ;;
            poweroff) kill -s USR1 1 ;;
        esac
    ;;

    runit)
        case ${0##*/} in
            reboot)   runit-init 6 ;;
            poweroff) runit-init 0 ;;
        esac
    ;;

    s6)
        cat <<EOF > /var/service/.s6-svscan/finish
#!/bin/sh
exec /usr/lib/init/rc.shutdown "${0##*/}"
EOF
        chmod +x /var/service/.s6-svscan/finish
        exec s6-svscanctl -t /var/service
    ;;

    *)
        printf 'error: CONFIG_INIT must be set in /etc/rc.conf\m' >&2
        exit 1
    ;;
esac
